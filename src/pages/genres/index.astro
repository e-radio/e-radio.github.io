---
import Layout from "../../layouts/Layout.astro";
import SEO from "../../components/SEO.astro";
import CategorySwitch from "../../components/CategorySwitch.astro";
import rawStations from "../../data/stations-gr.json";

const ogImage = "/e-radio-og-image.png";

const genreMap = new Map<string, typeof rawStations>();
for (const station of rawStations) {
  const genres = Array.isArray(station.genres) && station.genres.length > 0 ? station.genres : ["Other"];
  for (const genre of genres) {
    const key = genre.trim() || "Other";
    if (!genreMap.has(key)) {
      genreMap.set(key, []);
    }
    genreMap.get(key)?.push(station);
  }
}

const transliterateGreek = (input: string) => {
  const map: Record<string, string> = {
    Α: "a", Β: "v", Γ: "g", Δ: "d", Ε: "e", Ζ: "z", Η: "i", Θ: "th", Ι: "i", Κ: "k", Λ: "l", Μ: "m",
    Ν: "n", Ξ: "x", Ο: "o", Π: "p", Ρ: "r", Σ: "s", Τ: "t", Υ: "y", Φ: "f", Χ: "ch", Ψ: "ps", Ω: "o",
    α: "a", β: "v", γ: "g", δ: "d", ε: "e", ζ: "z", η: "i", θ: "th", ι: "i", κ: "k", λ: "l", μ: "m",
    ν: "n", ξ: "x", ο: "o", π: "p", ρ: "r", σ: "s", ς: "s", τ: "t", υ: "y", φ: "f", χ: "ch", ψ: "ps", ω: "o",
  };
  return input
    .normalize("NFD")
    .replace(/\p{Diacritic}/gu, "")
    .split("")
    .map((char) => map[char] ?? char)
    .join("");
};

const baseGenreSlug = (genre: string) =>
  transliterateGreek(genre || "")
    .toLowerCase()
    .trim()
    .replace(/['"]/g, "")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/^-+|-+$/g, "")
    .slice(0, 80) || "other";

const slugCounts = new Map<string, number>();
const genreEntries = [...genreMap.entries()]
  .map(([genre, stations]) => {
    const base = baseGenreSlug(genre);
    const nextCount = (slugCounts.get(base) || 0) + 1;
    slugCounts.set(base, nextCount);
    const slug = nextCount > 1 ? `${base}-${nextCount}` : base;
    return {
      genre,
      slug,
      stations: stations
        .slice()
        .sort((a, b) => (b.votes || 0) - (a.votes || 0)),
    } as const;
  })
  .sort((a, b) => a.genre.localeCompare(b.genre, undefined, { sensitivity: "base" }));

const genreBadgeEntries = genreEntries
  .slice()
  .sort((a, b) => {
    if (b.stations.length !== a.stations.length) {
      return b.stations.length - a.stations.length;
    }
    return a.genre.localeCompare(b.genre, undefined, { sensitivity: "base" });
  });

const siteRoot = "https://e-radio.github.io";
const canonical = `${siteRoot}/genres/`;
const pageTitle = "Greek Radio Stations by Genre | E-Radio";
const pageDescription = "Explore Greek radio stations by music genre and discover new sounds.";
const ogImageUrl = `${siteRoot}${ogImage}`;

const structuredData = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "@id": `${canonical}#collection`,
  name: pageTitle,
  url: canonical,
  description: pageDescription,
  image: ogImageUrl,
};
---

<Layout title={pageTitle} description={pageDescription}>
  <SEO
    slot="seo"
    title={pageTitle}
    description={pageDescription}
    canonical={canonical}
    ogTitle={pageTitle}
    ogDescription={pageDescription}
    ogImage={ogImageUrl}
    keywords="greek radio genres, music genres greece radio"
    robots="index, follow"
    author="E-Radio Greece"
    structuredData={structuredData}
  />
  <div class="mb-4">
    <h1 class="display-5 fw-bold mb-2">Stations by Genre</h1>
    <p class="lead text-muted">Browse stations grouped by their primary genres.</p>
    <p class="text-muted small">Genres arranged alphabetically; stations in each genre sorted by votes.</p>
  </div>
  <CategorySwitch current="genres" />
  <div class="mb-4">
    <h2 class="h6 text-muted text-uppercase">Browse genres</h2>
    <div class="d-flex flex-wrap gap-2">
      {genreBadgeEntries.map(({ genre, stations, slug }) => {
        return (
        <a class="text-decoration-none d-inline-flex align-items-center" href={`/genres/${slug}/`} aria-label={`${genre} radio stations (${stations.length})`}>
            <span class="badge border rounded-0 rounded-start bg-light text-light-emphasis fw-semibold">{genre}</span>
            <span class="badge border rounded-0 rounded-end bg-secondary-subtle text-secondary-emphasis">{stations.length}</span>
        </a>
        );
      })}
    </div>
  </div>
  <div class="row g-3">
    {genreEntries.map(({ genre, stations, slug }) => {
      const topStations = stations.slice(0, 3).map((station) => station.name).join(", ");
      return (
        <div class="col-12 col-md-6 col-xl-4">
          <a href={`/genres/${slug}/`} class="text-decoration-none">
            <div class="border rounded-3 p-3 h-100 d-flex flex-column justify-content-between">
              <div>
                <h2 class="h6 fw-bold text-dark mb-1">{genre}</h2>
                <p class="small text-muted mb-2">{stations.length} station{stations.length === 1 ? "" : "s"}</p>
                <p class="small text-muted mb-0">Top: {topStations || "Explore stations"}</p>
              </div>
              <span class="small text-primary fw-semibold mt-3">View stations →</span>
            </div>
          </a>
        </div>
      );
    })}
  </div>
</Layout>
