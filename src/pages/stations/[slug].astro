---
import Layout from "../../layouts/Layout.astro";
import SEO from "../../components/SEO.astro";
import rawStations from "../../data/stations-gr.json";
import radioAppIcon from "../../assets/radddio-app-icon.png";

export async function getStaticPaths() {
  return rawStations.map((station) => ({
    params: { slug: station.slug },
    props: { station },
  }));
}

interface Props {
  station: typeof rawStations[0];
}

const { station } = Astro.props;

// Get recommended stations based on genre and location
const getRecommendedStations = () => {
  const recommended: typeof rawStations = rawStations
    .filter((s: typeof rawStations[0]) => s.slug !== station.slug) // Exclude current station
    .map((s: typeof rawStations[0]) => {
      let score = 0;
      // Genre match (highest priority)
      if (station.genres.some((g: string) => (s.genres as string[]).includes(g))) {
        score += 12;
      }
      // Same state (medium priority)
      if (station.state && s.state === station.state) {
        score += 6;
      }
      // Same country (lowest priority)
      if (s.country === station.country) {
        score += 1;
      }
      return { station: s, score };
    })
    .filter((item) => item.score > 0) // Only stations with some relevance
    .sort((a, b) => {
      // Sort by score first, then by votes
      if (b.score !== a.score) return b.score - a.score;
      return (b.station.votes || 0) - (a.station.votes || 0);
    })
    .slice(0, 6) // Get top 5
    .map((item) => item.station);

  return recommended;
};

const recommendedStations = getRecommendedStations();

const siteRoot = "https://e-radio.github.io";
const canonical = `${siteRoot}/stations/${station.slug}/`;

const title = `${station.name} ‚Äì Live Radio Station in Greece | E-Radio`;
const description = station.state
  ? `Stream ${station.name} live from ${station.state}, Greece. ${station.genres.length > 0 ? `Listen to ${station.genres.slice(0, 2).join(", ")} radio online.` : "Listen to live radio online."}`
  : `Listen to ${station.name} live from Greece. Stream ${station.genres.length > 0 ? station.genres.slice(0, 2).join(", ") : "your favorite"} radio online.`;

// Structured data (JSON-LD)
const structuredData = {
  "@context": "https://schema.org",
  "@type": "RadioStation",
  "name": station.name,
  "url": canonical,
  "address": {
    "@type": "PostalAddress",
    "addressRegion": station.state || "Greece",
    "addressCountry": "GR"
  },
  "potentialAction": {
    "@type": "ListenAction",
    "target": station.stream_url || ""
  },
  "image": station.favicon || radioAppIcon.src,
  "description": description,
  "sameAs": station.homepage ? [station.homepage] : undefined,
  "identifier": station.stationuuid,
  "genre": station.genres.length > 0 ? station.genres : undefined,
  "broadcasts": {
    "@type": "BroadcastEvent",
    "name": station.name,
    "broadcastOfEvent": {
      "@type": "Event",
      "name": station.name
    }
  }
};
---

<Layout title={title} description={description}>
  <!-- SEO Meta Tags -->
  <SEO 
    slot="seo"
    title={title}
    description={description}
    canonical={canonical}
    ogTitle={title}
    ogDescription={description}
    ogImage={station.favicon || radioAppIcon.src}
    ogType="music.radio_station"
    keywords={`${station.name}, ${station.state || "Greece"}, radio, live, ${station.genres.join(", ")}`}
    robots="index, follow"
    author="E-Radio Greece"
    structuredData={structuredData}
  />
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex align-items-center gap-3 p-4 border border-light-subtle rounded">
        {station.favicon ? (
          <img src={station.favicon} alt={`${station.name} Logo`} class="rounded" style="width: 100px; height: 100px; object-fit: cover;" />
        ) : (
          <img src={radioAppIcon.src} alt="Radio App Icon" class="rounded" style="width: 100px; height: 100px; object-fit: cover;" />
        )}
        <div class="flex-grow-1">
          <h1 class="mb-2">{station.name}</h1>
          {station.state && (
            <p class="text-muted mb-0">
              üìç <span itemprop="areaServed">{station.state}, Greece</span>
            </p>
          )}
          {station.genres.length > 0 && (
            <p class="text-muted mb-0 small">
              üéµ <span itemprop="genre">{station.genres.slice(0, 3).join(", ")}</span>
            </p>
          )}
        </div>
        {station.votes && (
          <div class="text-end">
            <div class="fs-5 fw-bold">{station.votes || 0}</div>
            <div class="small text-muted">Community Votes</div>
          </div>
        )}
      </div>
    </div>
  </div>

  <div class="row g-4">
    <div class="col-12">
      <div class="card border border-light-subtle">
        <div class="card-header bg-light">
          <h2 class="mb-0 fs-5">Listen Live</h2>
        </div>
        <div class="card-body">
          {station.stream_url ? (
            <>
              <audio controls class="w-100 mb-3" itemprop="url">
                <source src={station.stream_url} />
                Your browser does not support the audio element.
              </audio>
              <div class="row">
                <div class="col-md-6">
                  <h3 class="fs-6">Stream Information</h3>
                  <ul class="list-unstyled">
                    {station.bitrate && (
                      <li><strong>Bitrate:</strong> <span itemprop="bitrate">{station.bitrate}</span> kbps</li>
                    )}
                    {station.codec && (
                      <li><strong>Codec:</strong> <span itemprop="encodingFormat">{station.codec}</span></li>
                    )}
                    {station.language && (
                      <li><strong>Language:</strong> <span itemprop="inLanguage">{station.language}</span></li>
                    )}
                  </ul>
                </div>
              </div>
            </>
          ) : (
            <div class="alert alert-warning mb-0">
              Stream is currently unavailable.
            </div>
          )}
        </div>
      </div>
    </div>

    {(station.homepage || station.genres.length > 0) && (
      <div class="col-12">
        <div class="card border border-light-subtle">
          <div class="card-header bg-light">
            <h2 class="mb-0 fs-5">About</h2>
          </div>
          <div class="card-body">
            {station.homepage && (
              <p>
                <strong>Website:</strong> 
                <a href={station.homepage} target="_blank" rel="noopener noreferrer" class="ms-2" itemprop="url">
                  {station.homepage}
                </a>
              </p>
            )}
            {station.genres.length > 0 && (
              <p>
                <strong>Genres:</strong> 
                {station.genres.map((genre, idx) => (
                  <>
                    {idx > 0 && ""}
                    <span class="badge bg-secondary" itemprop="genre">{genre}</span>
                  </>
                ))}
              </p>
            )}
            {station.votes && (
              <p class="mb-0">
                <strong>Community Votes:</strong> <span itemprop="aggregateRating">{station.votes}</span>
              </p>
            )}
          </div>
        </div>
      </div>
    )}
  </div>

  <div class="text-center mt-4">
    <a href="/" class="btn btn-outline-primary">
      &larr; Back to all stations
    </a>
  </div>

  {/* Recommended Stations Section - SEO Best Practice */}
  {recommendedStations.length > 0 && (
    <div class="mt-5">
      <div class="card border border-light-subtle">
        <div class="card-header bg-light">
          <h2 class="mb-0 fs-5">üìª Recommended Stations</h2>
        </div>
        <div class="card-body">
          <div class="row g-3">
            {recommendedStations.map((recStation) => (
              <div class="col-md-6 col-lg-4">
                  <a href={`/stations/${recStation.slug}/`} class="text-decoration-none">
                    <div class="card h-100 shadow-sm transition-hover" style="transition: transform 0.2s, box-shadow 0.2s;">
                      <div class="card-body">
                        <div class="d-flex gap-2 mb-3">
                          {recStation.favicon ? (
                            <img src={recStation.favicon} alt={recStation.name} class="rounded" style="width: 50px; height: 50px; object-fit: cover; flex-shrink: 0;" />
                          ) : (
                            <img src={radioAppIcon.src} alt="Radio Icon" class="rounded" style="width: 50px; height: 50px; object-fit: cover; flex-shrink: 0;" />
                          )}
                          <div style="flex: 1; min-width: 0;">
                            <h5 class="mb-1 text-dark" style="font-size: 0.95rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                              {recStation.name}
                            </h5>
                            {recStation.state && (
                              <small class="text-muted">üìç {recStation.state}</small>
                            )}
                          </div>
                        </div>
                        {recStation.genres.length > 0 && (
                          <div class="mb-2">
                            {recStation.genres.slice(0, 2).map((genre) => (
                              <span class="badge bg-info-subtle text-info-emphasis me-1" style="font-size: 0.75rem;">
                                {genre}
                              </span>
                            ))}
                          </div>
                        )}
                        <div class="d-flex justify-content-between align-items-center">
                          <small class="text-muted">{recStation.votes || 0} votes</small>
                          <small class="text-primary fw-bold">Listen ‚Üí</small>
                        </div>
                      </div>
                    </div>
                  </a>
                </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  )}
</Layout>