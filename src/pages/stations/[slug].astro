---
import Layout from "../../layouts/Layout.astro";
import SEO from "../../components/SEO.astro";
import rawStations from "../../data/stations-gr.json";


export async function getStaticPaths() {
  return rawStations.map((station) => ({
    params: { slug: station.slug },
    props: { station },
  }));
}

interface Props {
  station: typeof rawStations[0];
}

const radddioURL = "https://apple.co/4lNPQAH";
const radioAppIconUrl = "/radddio-app-icon.png";
const radddioBadgeUrl = "/radddio-badge.svg";
const { station } = Astro.props;

// Get recommended stations based on genre and location
const getRecommendedStations = () => {
  const recommended: typeof rawStations = rawStations
    .filter((s: typeof rawStations[0]) => s.slug !== station.slug) // Exclude current station
    .map((s: typeof rawStations[0]) => {
      let score = 0;
      // Genre match (highest priority)
      if (station.genres.some((g: string) => (s.genres as string[]).includes(g))) {
        score += 12;
      }
      // Same state (medium priority)
      if (station.state && s.state === station.state) {
        score += 6;
      }
      // Same country (lowest priority)
      if (s.country === station.country) {
        score += 1;
      }
      return { station: s, score };
    })
    .filter((item) => item.score > 0) // Only stations with some relevance
    .sort((a, b) => {
      // Sort by score first, then by votes
      if (b.score !== a.score) return b.score - a.score;
      return (b.station.votes || 0) - (a.station.votes || 0);
    })
    .slice(0, 6) // Get top 5
    .map((item) => item.station);

  return recommended;
};

const recommendedStations = getRecommendedStations();

const siteRoot = "https://e-radio.github.io";
const canonical = `${siteRoot}/stations/${station.slug}/`;
const ogImage = "/e-radio-og-image.png";
const ogImageUrl = station.favicon && station.favicon.startsWith("http")
  ? station.favicon
  : station.favicon
    ? `${siteRoot}${station.favicon}`
    : `${siteRoot}${ogImage}`;

const resolveEncodingFormat = (currentStation: typeof rawStations[0]) => {
  const streamUrl = String(currentStation.stream_url ?? "").toLowerCase();
  const codec = String(currentStation.codec ?? "").toLowerCase();

  if (currentStation.hls || streamUrl.includes(".m3u8")) {
    return "application/vnd.apple.mpegurl";
  }

  switch (codec) {
    case "mp3":
    case "mpeg":
    case "audio/mpeg":
      return "audio/mpeg";
    case "aac":
    case "aac+":
    case "aacplus":
    case "aacp":
    case "audio/aac":
      return "audio/aac";
    case "ogg":
    case "oga":
      return "audio/ogg";
    case "opus":
      return "audio/opus";
    case "flac":
      return "audio/flac";
    case "wav":
      return "audio/wav";
    case "wma":
      return "audio/x-ms-wma";
    default:
      break;
  }

  if (streamUrl.endsWith(".aac")) {
    return "audio/aac";
  }
  if (streamUrl.endsWith(".mp3")) {
    return "audio/mpeg";
  }
  if (streamUrl.endsWith(".ogg") || streamUrl.endsWith(".oga")) {
    return "audio/ogg";
  }

  return undefined;
};

const encodingFormat = resolveEncodingFormat(station);

const title = `${station.name} ‚Äì Live Radio Station in Greece | E-Radio`;
const description = station.state
  ? `Stream ${station.name} live from ${station.state}, Greece. ${station.genres.length > 0 ? `Listen to ${station.genres.slice(0, 2).join(", ")} radio online.` : "Listen to live radio online."}`
  : `Listen to ${station.name} live from Greece. Stream ${station.genres.length > 0 ? station.genres.slice(0, 2).join(", ") : "your favorite"} radio online.`;

// Structured data (JSON-LD)
const structuredData = {
  "@context": "https://schema.org",
  "@type": "RadioStation",
  "@id": `${canonical}#radiostation`,
  "name": station.name,
  "url": canonical,
  "description": description,
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": canonical
  },
  "image": ogImageUrl,
  "logo": ogImageUrl,
  "identifier": station.stationuuid,
  ...(station.homepage ? { "sameAs": [station.homepage] } : {}),
  ...(station.state
    ? {
        "areaServed": {
          "@type": "AdministrativeArea",
          "name": station.state,
          "containedInPlace": {
            "@type": "Country",
            "name": station.country || "Greece",
            "identifier": String(station.countrycode || "GR").toUpperCase()
          }
        }
      }
    : {
        "areaServed": {
          "@type": "Country",
          "name": station.country || "Greece",
          "identifier": String(station.countrycode || "GR").toUpperCase()
        }
      }),
  ...(station.stream_url
    ? {
        "subjectOf": {
          "@type": "AudioObject",
          "name": `${station.name} Live Stream`,
          "contentUrl": station.stream_url,
          ...(encodingFormat ? { "encodingFormat": encodingFormat } : {}),
          ...(station.language ? { "inLanguage": station.language } : {}),
          ...(station.genres.length > 0 ? { "genre": station.genres } : {})
        }
      }
    : {})
};
---

<Layout title={title} description={description}>
  <!-- SEO Meta Tags -->
  <SEO 
    slot="seo"
    title={title}
    description={description}
    canonical={canonical}
    ogTitle={title}
    ogDescription={description}
    ogImage={ogImageUrl}
    ogType="music.radio_station"
    keywords={`${station.name}, ${station.state || "Greece"}, radio, live, ${station.genres.join(", ")}`}
    robots="index, follow"
    author="E-Radio Greece"
    structuredData={structuredData}
  />
  <div class="d-flex mb-3">
    <nav aria-label="Breadcrumb">
      <ol class="breadcrumb justify-content-center mb-0">
        <li class="breadcrumb-item"><a href="/">All Stations</a></li>
        <li class="breadcrumb-item active" aria-current="page">{station.name}</li>
      </ol>
    </nav>
  </div>
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex align-items-center gap-3 p-4 border border-light-subtle rounded">
        {station.favicon ? (
          <img src={station.favicon} alt={`${station.name} Logo`} class="rounded" style="width: 100px; height: 100px; object-fit: cover;" />
        ) : (
          <img src={radioAppIconUrl} alt="Radio App Icon" class="rounded" style="width: 100px; height: 100px; object-fit: cover;" />
        )}
        <div class="flex-grow-1">
          <h1 class="mb-2">{station.name}</h1>
          {station.state && (
            <p class="text-muted mb-0">
              üìç <span>{station.state}, Greece</span>
            </p>
          )}
          {station.genres.length > 0 && (
            <p class="text-muted mb-0 small">
              üéµ <span>{station.genres.slice(0, 3).join(", ")}</span>
            </p>
          )}
        </div>
        {station.votes && (
          <div class="text-end">
            <a href={radddioURL} class="text-decoration-none radddio-badge" target="_blank" aria-label="Listen On Radddio" style="position:relative;z-index:3;"><img src={radddioBadgeUrl} alt="Radddio App Badge" /></a>
          </div>
        )}
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-12">
      <div class="card border border-light-subtle">
        <div class="card-header bg-light">
          <h2 class="mb-0 fs-5">Listen Live</h2>
        </div>
        <div class="card-body">
          {station.stream_url ? (
            <>
              <audio controls src={station.stream_url} class="w-100 mb-3" preload="none">
                Your browser does not support the audio element.
              </audio>
              <div class="d-flex flex-wrap gap-2 mb-2">
                <a href={station.stream_url} class="btn btn-primary" target="_blank" rel="noopener noreferrer">
                  Open Stream
                </a>
                <a href={radddioURL} class="btn btn-outline-primary" target="_blank" rel="noopener noreferrer">
                  Listen on Radddio
                </a>
              </div>
              {(station.bitrate || station.codec) && (
                <p class="text-muted small mb-0">
                  Stream quality: {station.bitrate ? `${station.bitrate} kbps` : "Unknown"}{station.codec ? ` ‚Ä¢ ${station.codec}` : ""}
                </p>
              )}
            </>
          ) : (
            <div class="d-flex flex-wrap gap-2">
              <a href={radddioURL} class="btn btn-primary" target="_blank" rel="noopener noreferrer">
                Listen on Radddio
              </a>
              {station.homepage && (
                <a href={station.homepage} class="btn btn-outline-secondary" target="_blank" rel="noopener noreferrer">
                  Visit Station Website
                </a>
              )}
              <p class="text-muted small mb-0 w-100">
                Stream is currently unavailable.
              </p>
            </div>
          )}
        </div>
      </div>
    </div>
  </div>

  {(station.homepage || station.genres.length > 0) && (
    <div class="row mb-4">
      <div class="col-12">
        <div class="card border border-light-subtle">
          <div class="card-header bg-light">
            <h2 class="mb-0 fs-5">About</h2>
          </div>
          <div class="card-body">
            {station.homepage && (
              <p>
                <strong>Website:</strong> 
                <a href={station.homepage} target="_blank" rel="noopener noreferrer" class="ms-2">
                  {station.homepage}
                </a>
              </p>
            )}
            {station.genres.length > 0 && (
              <p>
                <strong>Genres:</strong> 
                {station.genres.map((genre, idx) => (
                  <>
                    {idx > 0 && ""}
                    <span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill">{genre}</span>
                  </>
                ))}
              </p>
            )}
            {station.votes && (
              <p class="mb-0">
                <strong>Community Votes:</strong> <span>{station.votes}</span>
              </p>
            )}
            {station.stationuuid && (
              <p class="mb-0">
                <strong>Station ID:</strong> <span>{station.stationuuid}</span>
              </p>
            )}
          </div>
        </div>
      </div>
    </div>
  )}
  {/* More Stations Section */}
  {recommendedStations.length > 0 ? (
    <div class="mt-5">
      <h2 class="fs-5">More Stations</h2>
      <div>
        <div class="station-list border border-light-subtle rounded-3 overflow-hidden">
          {recommendedStations.map((recStation, index) => {
            return (
              <div class={`station-item position-relative ${index !== recommendedStations.length - 1 ? 'border-bottom border-light-subtle' : ''}`}>
                <a href={`/stations/${recStation.slug}/`} class="stretched-link" style="position:absolute;inset:0;z-index:2;" aria-label={`Go to ${recStation.name}`}></a>
                <div class="station-item-body p-3">
                  <div class="row align-items-center g-3">
                    <div class="col-auto">
                      <div class="votes-badge bg-light rounded d-flex flex-column align-items-center justify-content-center p-2" style="width: 50px; height: 50px;">
                        <span class="small fw-bold">{recStation.votes || 0}</span>
                        <span class="badge-text small" style="font-size: 0.65rem;">votes</span>
                      </div>
                    </div>
                    <div class="col-auto">
                      {recStation.favicon ? (
                        <img src={recStation.favicon} alt={`${recStation.name} Logo`} class="rounded" style="width: 60px; height: 60px; object-fit: cover;" />
                      ) : (
                        <img src={radioAppIconUrl} alt="Radddio App Icon" class="rounded" style="width: 60px; height: 60px; object-fit: cover;" />
                      )}
                    </div>
                    <div class="col flex-grow-1">
                      <h3 class="mb-1 fs-6 fw-bold text-dark">{recStation.name}</h3>
                      <p class="mb-2 small text-muted" style="margin: 0;">
                        {recStation.state ? <span>üìç {recStation.state}</span> : null}
                        {recStation.bitrate ? <span class="ms-2">üéµ {recStation.bitrate} kbps</span> : null}
                      </p>
                      <div class="d-flex gap-2 flex-wrap">
                        {recStation.genres && recStation.genres.slice(0, 3).map((genre) => (
                          <span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill">{genre}</span>
                        ))}
                      </div>
                    </div>
                    <div class="col-auto text-end d-none d-md-block">
                      <a href={radddioURL} class="text-decoration-none radddio-badge" target="_blank" aria-label="Listen On Radddio" style="position:relative;z-index:3;"><img src={radddioBadgeUrl} alt="Radddio App Badge" /></a>
                    </div>
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      </div>
    </div>
  ) : null}
</Layout>